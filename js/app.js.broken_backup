// --- Configuration ---
const GOOGLE_API_KEY = ''; // Add your API key here if needed for public deployment, currently using implicit or restricted key
// Note: In a real production app, use a proxy server to hide API keys.

// --- Supabase Client ---
const supabaseUrl = 'https://rqbtntzqqkekdzvfilos.supabase.co';
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJxYnRudHpxcWtla2R6dmZpbG9zIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ1MDEwMjUsImV4cCI6MjA4MDA3NzAyNX0.iKeTABH2Q_s9BjpMmigroSa0fqeyW8DDcmXRwDO0jjM';
const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

// --- State ---
let user = null;
let savedBookIds = new Set();
let allSavedBooks = []; // Store full list for client-side filtering
// Font Size State
const fontSizes = ['90%', '100%', '110%', '125%'];
let currentFontSizeIndex = 1; // Default to 100%

// --- DOM Elements ---
const authSection = document.getElementById('auth-section');
const appSection = document.getElementById('app-section');
const loginForm = document.getElementById('login-form');
const emailInput = document.getElementById('email');
const passwordInput = document.getElementById('password');
const navActions = document.getElementById('nav-actions');
const logoutBtn = document.getElementById('logout-btn');

const searchInput = document.getElementById('search-input');
const searchBtn = document.getElementById('search-btn');
const resultsContainer = document.getElementById('results-container');
const resultsGrid = document.getElementById('results-grid');

const savedGrid = document.getElementById('saved-grid');
const savedTableContainer = document.getElementById('saved-table-container');
const savedTableBody = document.getElementById('saved-table-body');
const refreshSavedBtn = document.getElementById('refresh-saved-btn');
const viewGridBtn = document.getElementById('view-grid-btn');
const viewTableBtn = document.getElementById('view-table-btn');
const importBtn = document.getElementById('nav-import-btn');

// Filter Elements
const filterTag = document.getElementById('filter-tag');
// filterYear removed (replaced by custom logic)
// filterStatus removed (replaced by custom logic)
const sortBy = document.getElementById('sort-by');

// --- Filtering & Sorting ---
// function applyFilters moved to main definition below

// Modal Elements
const modal = document.getElementById('book-modal');
const closeModalBtn = document.getElementById('close-modal-btn');
const closeModalBottomBtn = document.getElementById('close-modal-bottom-btn');
const modalImage = document.getElementById('modal-image');
const modalTitle = document.getElementById('modal-title');
const modalAuthors = document.getElementById('modal-authors');
// modalYear removed
const modalPages = document.getElementById('modal-pages');
const modalRating = document.getElementById('modal-rating');
const modalOlRating = document.getElementById('modal-ol-rating');
const modalDescription = document.getElementById('modal-description');
const modalDescriptionContainer = document.getElementById('modal-description-container');
const seeMoreBtn = document.getElementById('see-more-btn');
const linkGoodreads = document.getElementById('link-goodreads');
const linkAmazon = document.getElementById('link-amazon');
const linkLibrary = document.getElementById('link-library');

const modalSaveSection = document.getElementById('modal-save-section');
const modalSaveBtn = document.getElementById('modal-save-btn');

const modalEditSection = document.getElementById('modal-edit-section');
const editStatus = document.getElementById('edit-status');
const editRating = document.getElementById('edit-rating');
// const editTags = document.getElementById('edit-tags'); // Replaced by interactive UI
const modalTagsContainer = document.getElementById('modal-tags-container');
const addTagInput = document.getElementById('add-tag-input');
const tagSuggestions = document.getElementById('tag-suggestions');
const addTagBtn = document.getElementById('add-tag-btn');
let currentModalTags = []; // State for modal tags
const editDate = document.getElementById('edit-date');
// editClubYear removed
const editHost = document.getElementById('edit-host');
const editNotes = document.getElementById('edit-notes');
const modalUpdateBtn = document.getElementById('modal-update-btn');
const modalDeleteBtn = document.getElementById('modal-delete-btn');

// Error Modal Elements
const errorModal = document.getElementById('error-modal');
const errorMessage = document.getElementById('error-message');
const closeErrorBtn = document.getElementById('close-error-btn');

// Import Modal Elements
const importModal = document.getElementById('import-modal');
const closeImportBtn = document.getElementById('close-import-btn');
const cancelImportBtn = document.getElementById('cancel-import-btn');
const startImportBtn = document.getElementById('start-import-btn');
const importText = document.getElementById('import-text');
const importProgress = document.getElementById('import-progress');
const importBar = document.getElementById('import-bar');
const importStatus = document.getElementById('import-status');
const importReviewSection = document.getElementById('import-review-section');
const importReviewList = document.getElementById('import-review-list');
const importAutoSummary = document.getElementById('import-auto-summary');
const saveImportBtn = document.getElementById('save-import-btn');
const importInstructions = document.getElementById('import-instructions');
let importCandidates = []; // Store search results for review
let autoImported = []; // Store exact matches ready for saving

// Dashboard Elements
const dashboardSection = document.getElementById('dashboard-section');
const dashboardHero = document.getElementById('dashboard-hero');
const dashboardUpcomingContainer = document.getElementById('dashboard-upcoming-container');
const dashboardUpcomingList = document.getElementById('dashboard-upcoming-list');
const dashboardEmpty = document.getElementById('dashboard-empty');


// --- Auth Logic ---

async function handleAuth(e) {
    e.preventDefault();
    const email = emailInput.value;
    const password = passwordInput.value;

    const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
    });

    if (error) {
        showError(error.message);
    } else {
        // UI updates handled by onAuthStateChange
    }
}

function updateUI() {
    if (user) {
        authSection.classList.add('hidden');
        appSection.classList.remove('hidden');
        navActions.classList.remove('hidden');

        // Init Font Size
        initFontSize();

        // Default to Dashboard view
        showSection('dashboard');
        fetchSavedBooks(); // Load books then render dashboard
    } else {
        authSection.classList.remove('hidden');
        appSection.classList.add('hidden');
        navActions.classList.add('hidden');
    }
}

loginForm.addEventListener('submit', handleAuth);

logoutBtn.addEventListener('click', async () => {
    await supabase.auth.signOut();
});

// --- Font Size Logic ---
const textSizeBtn = document.getElementById('text-size-btn');
const textSizeMenu = document.getElementById('text-size-menu');

function initFontSize() {
    const saved = localStorage.getItem('bookClubFontSize') || '100%';
    setFontSize(saved, false); // false = don't save again
}

function setFontSize(size, save = true) {
    document.documentElement.style.fontSize = size;
    if (save) localStorage.setItem('bookClubFontSize', size);
    updateFontSizeMenu(size);
}

function updateFontSizeMenu(activeSize) {
    if (!textSizeMenu) return;
    const buttons = textSizeMenu.querySelectorAll('button');
    buttons.forEach(btn => {
        if (btn.dataset.size === activeSize) {
            btn.classList.add('active');
            btn.querySelector('span.text-rose-600').classList.remove('hidden');
        } else {
            btn.classList.remove('active');
            btn.querySelector('span.text-rose-600').classList.add('hidden');
        }
    });
}

// Event Listeners
if (textSizeBtn && textSizeMenu) {
    textSizeBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        textSizeMenu.classList.toggle('hidden');
    });

    textSizeMenu.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
            const size = btn.dataset.size;
            setFontSize(size);
        });
    });

    window.addEventListener('click', () => {
        textSizeMenu.classList.add('hidden');
    });
}

// --- Custom Status Dropdown Logic ---
const filterStatusBtn = document.getElementById('filter-status-btn');
const filterStatusMenu = document.getElementById('filter-status-menu');
const filterStatusLabel = document.getElementById('filter-status-label');
let currentStatusFilter = 'all'; // State for the filter

if (filterStatusBtn && filterStatusMenu) {
    // Toggle Menu
    filterStatusBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        filterStatusMenu.classList.toggle('hidden');
        // Close other menus if open (optional)
    });

    // Handle Selection
    filterStatusMenu.querySelectorAll('button').forEach(btn => {
        btn.addEventListener('click', () => {
            const value = btn.dataset.value;
            currentStatusFilter = value;

            // Update UI Label
            filterStatusLabel.textContent = value === 'all' ? 'Statuses' : value;

            // Update Active State
            filterStatusMenu.querySelectorAll('button').forEach(b => b.classList.remove('text-rose-600', 'bg-stone-50'));
            if (value !== 'all') btn.classList.add('text-rose-600', 'bg-stone-50');

            // Apply Filter
            applyFilters();

            // Close Menu
            filterStatusMenu.classList.add('hidden');
        });
    });

    // Close on Click Outside
    window.addEventListener('click', (e) => {
        if (!filterStatusBtn.contains(e.target) && !filterStatusMenu.contains(e.target)) {
            filterStatusMenu.classList.add('hidden');
        }
    });
}

// --- Custom Year Dropdown Logic ---
const filterYearBtn = document.getElementById('filter-year-btn');
const filterYearMenu = document.getElementById('filter-year-menu');
const filterYearLabel = document.getElementById('filter-year-label');
let currentYearFilter = 'all';

if (filterYearBtn && filterYearMenu) {
    filterYearBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        filterYearMenu.classList.toggle('hidden');
    });

    window.addEventListener('click', (e) => {
        if (!filterYearBtn.contains(e.target) && !filterYearMenu.contains(e.target)) {
            filterYearMenu.classList.add('hidden');
        }
    });
}

// Ensure login persists
supabase.auth.onAuthStateChange((event, session) => {
    if (event === 'SIGNED_IN' || event === 'INITIAL_SESSION') {
        user = session?.user;
        updateUI();
    } else if (event === 'SIGNED_OUT') {
        user = null;
        window.location.reload();
    }
});

// Check initial session
// Check initial session
supabase.auth.getSession().then(({ data: { session } }) => {
    // onAuthStateChange handles the UI update. 
    // We just ensure user is synced if needed, but usually the listener catches it.
    if (session?.user) {
        user = session.user;
    }
});


// --- Search Logic ---

searchBtn.addEventListener('click', performSearch);
searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') performSearch();
});

async function performSearch() {
    const query = searchInput.value.trim();
    if (!query) return;

    searchBtn.textContent = 'Searching...';
    searchBtn.disabled = true;
    resultsContainer.classList.remove('hidden');
    resultsGrid.innerHTML = '<p class="text-center col-span-full text-stone-500">Searching Google Books...</p>';

    try {
        const response = await fetch(`https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=12&key=${GOOGLE_API_KEY}`);
        const data = await response.json();

        resultsGrid.innerHTML = '';

        if (data.items && data.items.length > 0) {
            data.items.forEach(book => {
                const card = createBookCard(book);
                resultsGrid.appendChild(card);
            });
        } else {
            resultsGrid.innerHTML = '<p class="text-center col-span-full text-stone-500">No books found.</p>';
        }

    } catch (error) {
        console.error('Search error:', error);
        resultsGrid.innerHTML = '<p class="text-center col-span-full text-red-500">Error searching books. Please try again.</p>';
    }

    searchBtn.textContent = 'Search';
    searchBtn.disabled = false;
}

function createBookCard(book) {
    const info = book.volumeInfo;
    const isSaved = savedBookIds.has(book.id);
    const thumbnail = info.imageLinks?.thumbnail || 'https://via.placeholder.com/128x192?text=No+Cover';
    const authors = info.authors ? info.authors.join(', ') : 'Unknown Author';
    const year = info.publishedDate ? info.publishedDate.substring(0, 4) : '';

    const div = document.createElement('div');
    div.className = 'card-modern flex flex-row items-center h-full fade-in group relative';
    div.innerHTML = `
        <div class="book-frame-modern w-20 md:w-24 border-r border-stone-200 self-stretch">
            <img src="${thumbnail}" alt="${info.title}" class="book-cover-shadow w-full h-auto object-contain max-h-full">
        </div>

        <div class="p-3 md:p-4 flex flex-col justify-center min-w-0 flex-grow">
            <h3 class="font-serif font-bold text-base text-stone-800 leading-tight mb-1 truncate" title="${info.title}">${info.title}</h3>
            <p class="text-xs text-stone-600 mb-1 truncate">${authors}</p>
            <p class="text-[10px] text-stone-400 mb-2">${year}</p>
            
            <div class="flex items-center gap-2 mt-auto">
                <button class="text-[10px] ${isSaved ? 'bg-green-100 text-green-700 border-green-200 cursor-default' : 'btn-secondary border-rose-200 text-rose-600 hover:bg-rose-50'} px-2.5 py-1 rounded-full transition font-medium"
                    data-book-id="${book.id}">
                    ${isSaved ? 'Saved!' : 'View Details'}
                </button>
            </div>
        </div>
    `;

    // Click handler for the whole card or button
    div.addEventListener('click', () => openModal(book));

    return div;
}

// --- Error Handling ---

function showError(msg) {
    errorMessage.textContent = msg;
    errorModal.classList.remove('hidden');
}

closeErrorBtn.addEventListener('click', () => {
    errorModal.classList.add('hidden');
});

// --- Auto-Tagging Logic ---
function generateTags(book) {
    const info = book.volumeInfo;
    const tags = new Set();
    const categories = (info.categories || []).map(c => c.toLowerCase());
    const isExplicitlyFiction = categories.some(c => c.includes('fiction') && !c.includes('non-fiction'));

    // 1. Add Categories (Cleaned)
    if (info.categories) {
        info.categories.forEach(c => {
            if (c === 'Business & Economics') {
                tags.add('Business/Econ');
            } else if (c.includes('Fiction')) {
                // Don't add generic "Fiction" tag, wait for specific sub-genres
            } else {
                tags.add(c);
            }
        });
    }

    // 2. Scan Description for Keywords
    const text = (info.description || '') + ' ' + (info.title || '');
    const lowerText = text.toLowerCase();

    // A. Genres & Themes
    const keywords = {
        'Mystery': ['mystery', 'detective', 'crime', 'thriller', 'murder'],
        'Sci-Fi': ['science fiction', 'sci-fi', 'space opera', 'alien', 'cyberpunk', 'time travel'],
        'Fantasy': ['fantasy', 'magic', 'wizard', 'dragon', 'sword', 'witch'],
        'Historical': ['historical fiction', 'historical', 'ancient', 'medieval', 'victorian'], // Changed from 'Historical Fiction' to 'Historical'
        'Romance': ['romance', 'love story'],
        'Memoir': ['memoir', 'autobiography', 'diary'],
        'Biography': ['biography'], // Removed 'life of' - too generic (e.g. "life of a sea woman")
        'Non-Fiction': ['non-fiction', 'history', 'psychology', 'business', 'self-help', 'science'],
        'Classic': ['classic literature', 'classic'],
        'Dystopian': ['dystopian', 'post-apocalyptic'],
        'Young Adult': ['young adult', 'ya '],
        'Thriller': ['thriller', 'suspense', 'psychological'],
        'Women\'s Fiction': ['women\'s fiction', 'female friendship'],
        'Literary Fiction': ['literary fiction']
    };

    for (const [tag, words] of Object.entries(keywords)) {
        if (words.some(w => lowerText.includes(w))) {
            tags.add(tag);
        }
    }

    // B. Decades / Eras (Regex)
    // Matches 1900s-1990s
    const yearMatch = text.match(/\b(19\d{2})s?\b/);
    if (yearMatch) {
        const year = parseInt(yearMatch[1]);
        if (year >= 1900 && year < 2000) {
            const decade = Math.floor(year / 10) * 10;
            tags.add(`${decade}s`);
        }
    }
    // Specific Eras
    if (lowerText.includes('world war ii') || lowerText.includes('wwii') || lowerText.includes('second world war')) tags.add('WWII');
    if (lowerText.includes('world war i') || lowerText.includes('wwi') || lowerText.includes('first world war')) tags.add('WWI');
    if (lowerText.includes('civil war')) tags.add('Civil War');
    if (lowerText.includes('cold war')) tags.add('Cold War');
    if (lowerText.includes('depression') && lowerText.includes('great')) tags.add('Great Depression');

    // C. Locations
    const locations = {
        'France': ['france', 'paris', 'french'],
        'England': ['england', 'london', 'british', 'english'],
        'US South': ['us south', 'american south', 'georgia', 'alabama', 'mississippi', 'carolina'],
        'New York': ['new york', 'nyc', 'manhattan', 'brooklyn'],
        'Italy': ['italy', 'rome', 'venice', 'italian'],
        'India': ['india', 'indian', 'mumbai', 'delhi'],
        'Africa': ['africa', 'african', 'nigeria', 'kenya'],
        'Asia': ['asia', 'asian', 'china', 'japan', 'korea'],
        'Ireland': ['ireland', 'irish', 'dublin'],
        'Israel': ['israel', 'jerusalem', 'tel aviv']
    };

    for (const [loc, words] of Object.entries(locations)) {
        if (words.some(w => lowerText.includes(w))) {
            tags.add(loc);
        }
    }

    // 3. Logic Deduction (Compound Genres)
    // Rule: If it works like History but talks like Fiction, it's Historical Fiction.
    const hasFiction = tags.has('Fiction') || isExplicitlyFiction || tags.has('Historical Fiction');
    const hasHistory = tags.has('History') || tags.has('Historical');

    if (hasFiction && hasHistory) {
        tags.add('Historical Fiction');
        tags.delete('History');
        tags.delete('Historical');
        tags.delete('Fiction'); // Sub-genre replaces parent
        tags.delete('Non-Fiction'); // History often triggers this, remove it
    }

    // 4. Refine Tags (Final Exclusions)

    // Safety Check: If Google says it's Fiction, REMOVE Non-Fiction tags derived from keywords
    if (isExplicitlyFiction) {
        tags.delete('Non-Fiction');
        tags.delete('Biography'); // Usually biographic fiction
        tags.delete('Memoir');
    }

    // Standard Exclusions
    if (tags.has('Non-Fiction')) {
        tags.delete('Fiction');
        tags.delete('Sci-Fi');
        tags.delete('Fantasy');
        tags.delete('Thriller');
        tags.delete('Mystery');
        tags.delete('Romance');
        tags.delete('Women\'s Fiction');
        tags.delete('Historical Fiction');
    }

    if (!tags.has('Non-Fiction')) {
        // Sub-genre cleanup for Fiction
        if (tags.has('Sci-Fi') || tags.has('Fantasy') || tags.has('Mystery') || tags.has('Thriller') || tags.has('Historical Fiction')) {
            tags.delete('Fiction');
        }
    }

    // If Memoir/Biography survives the Fiction purge, it enforces Non-Fiction
    if (tags.has('Memoir') || tags.has('Biography')) {
        tags.add('Non-Fiction');
        tags.delete('Fiction');
    }

    return Array.from(tags).join(', ');
}

// --- Modal Logic ---

function openModal(book, savedData = null) {
    const info = book.volumeInfo;
    const isSaved = savedBookIds.has(book.id);

    // Update suggestions
    updateTagSuggestions();

    // Clear previous badges
    const existingBadge = document.getElementById('ebook-badge');
    if (existingBadge) existingBadge.remove();

    // Populate Basic Data
    // Phase 2: Robust Image Fallback (High Res -> Standard -> Placeholder)
    const setCoverImage = (url) => {
        // Helper to ensure HTTPS
        if (url && url.startsWith('http:')) {
            url = url.replace('http:', 'https:');
        }
        return url;
    };

    const standardThumb = setCoverImage(info.imageLinks?.thumbnail);

    // FIX: Rely on the standard thumbnail (zoom=1) which is reliable and matches the library view.
    // We only remove the 'edge=curl' parameter for a cleaner look if possible.
    let modalThumb = null;
    if (standardThumb) {
        modalThumb = standardThumb.replace('&edge=curl', '');
    }

    const placeholder = 'https://via.placeholder.com/128x192?text=No+Cover';

    // Reset loop protection
    modalImage.onload = null;
    modalImage.onerror = null;

    if (modalThumb) {
        modalImage.src = modalThumb;
        modalImage.onerror = () => {
            // Fallback to placeholder if even the standard thumb fails
            modalImage.src = placeholder;
            modalImage.onerror = null; // Prevent infinite loop
        };
    } else {
        modalImage.src = placeholder;
    }

    modalTitle.textContent = info.title;
    modalAuthors.textContent = info.authors ? info.authors.join(', ') : 'Unknown Author';
    // modalYear assignment removed
    modalPages.textContent = info.pageCount ? `${info.pageCount} pages` : 'Page count unknown';

    if (info.averageRating) {
        modalRating.textContent = `Google: ★ ${info.averageRating}`;
        modalRating.classList.remove('hidden');
    } else {
        modalRating.classList.add('hidden');
    }

    // Reset Open Library Rating
    modalOlRating.classList.add('hidden');
    modalOlRating.textContent = '';

    modalDescription.innerHTML = info.description || 'No description available.';

    // Reset See More
    modalDescriptionContainer.classList.add('line-clamp-3');
    seeMoreBtn.textContent = 'See more';
    seeMoreBtn.classList.add('hidden');

    // Setup Research Links
    const isbnObj = info.industryIdentifiers?.find(id => id.type === 'ISBN_13') || info.industryIdentifiers?.find(id => id.type === 'ISBN_10');
    const isbn = isbnObj ? isbnObj.identifier : null;

    const query = encodeURIComponent(`${info.title} ${info.authors ? info.authors[0] : ''}`);

    if (isbn) {
        linkGoodreads.href = `https://www.goodreads.com/search?q=${isbn}`;
        linkAmazon.href = `https://www.amazon.com/s?k=${isbn}&i=stripbooks`;
        linkLibrary.href = `https://search.worldcat.org/search?q=bn:${isbn}`;
        linkLibrary.classList.remove('hidden');

        // Fetch Open Library Rating
        fetchOpenLibraryRating(isbn, info.title, info.authors ? info.authors[0] : null);
    } else {
        linkGoodreads.href = `https://www.goodreads.com/search?q=${query}`;
        linkAmazon.href = `https://www.amazon.com/s?k=${query}&i=stripbooks`;
        linkLibrary.classList.add('hidden'); // Hide if no ISBN

        // Try fetching rating without ISBN
        fetchOpenLibraryRating(null, info.title, info.authors ? info.authors[0] : null);
    }

    // eBook/Audiobook Availability (from Google Data)
    // We can check info.saleInfo.isEbook or accessInfo.epub.isAvailable
    // We'll append a badge to the year/pages section
    const ebookAvailable = info.saleInfo?.isEbook || book.accessInfo?.epub?.isAvailable;
    if (ebookAvailable) {
        const badge = document.createElement('span');
        badge.id = 'ebook-badge';
        badge.className = 'bg-green-50 text-green-700 px-3 py-1 rounded-full border border-green-200';
        badge.textContent = 'eBook Available';
        modalPages.parentNode.appendChild(badge);
    }

    // Toggle Sections based on Saved Status
    if (isSaved) {
        modalSaveSection.classList.add('hidden');
        modalEditSection.classList.remove('hidden');

        // Reset Delete Button State (Fix for stuck "Deleting..." bug)
        modalDeleteBtn.textContent = 'Delete';
        modalDeleteBtn.disabled = false;

        // If savedData is missing (e.g. opened from search), try to find it in our local cache
        if (!savedData) {
            savedData = allSavedBooks.find(b => b.google_data.id === book.id);
        }

        if (savedData) {
            modalSaveSection.classList.add('hidden');
            modalEditSection.classList.remove('hidden');

            editStatus.value = savedData.status || '';
            editRating.value = savedData.rating ? String(savedData.rating) : ''; // Ensure it's a string for input value
            currentModalTags = savedData.tags && savedData.tags.length > 0 ? [...savedData.tags] : generateTags(book).split(', ').filter(t => t);
            renderModalTags();
            editDate.value = savedData.target_date || '';
            editHost.value = savedData.host_name || '';
            editNotes.value = savedData.user_notes || '';

            modalUpdateBtn.onclick = () => updateBook(savedData.id, book);

            // Setup Delete Button
            modalDeleteBtn.onclick = () => deleteBook(savedData.id);
        } else {
            // Fallback if we somehow have the ID in the set but not the data (should be rare)
            modalEditSection.classList.add('hidden');
            modalSaveSection.classList.remove('hidden');
            modalSaveBtn.textContent = 'Already Saved (Refresh to Edit)';
            modalSaveBtn.disabled = true;
            modalSaveBtn.className = 'w-full md:w-auto bg-green-100 text-green-700 border border-green-200 px-6 py-2 rounded-full font-medium shadow-sm cursor-default';
        }

    } else {
        modalSaveSection.classList.remove('hidden');
        modalEditSection.classList.add('hidden');

        modalSaveBtn.textContent = 'Save to List';
        modalSaveBtn.disabled = false;
        modalSaveBtn.className = 'w-full md:w-auto btn-primary';

        modalSaveBtn.onclick = async () => {
            await saveBook(modalSaveBtn, book);
            // Update the button in the grid if visible
            const gridBtn = document.querySelector(`button[data-book-id="${book.id}"]`);
            if (gridBtn) {
                gridBtn.textContent = 'Saved!';
                gridBtn.classList.remove('bg-white', 'text-rose-600', 'border', 'border-rose-200', 'hover:bg-rose-50');
                gridBtn.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'cursor-default');
            }
            closeModal();
        };
    }

    // Show Modal
    modal.classList.remove('hidden');
    document.body.style.overflow = 'hidden'; // Prevent background scrolling

    // Check for description overflow
    setTimeout(() => {
        if (modalDescriptionContainer.scrollHeight > modalDescriptionContainer.clientHeight) {
            seeMoreBtn.classList.remove('hidden');
        }
    }, 0);
}

function closeModal() {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
}

closeModalBtn.addEventListener('click', closeModal);
if (closeModalBottomBtn) closeModalBottomBtn.addEventListener('click', closeModal);

modal.addEventListener('click', (e) => {
    if (e.target === modal) {
        closeModal();
    }
});

async function updateBook(id, googleBook) {
    try {
        modalUpdateBtn.textContent = 'Updating...';
        modalUpdateBtn.disabled = true;

        const updates = {
            status: editStatus.value || null,
            rating: editRating.value ? parseFloat(editRating.value) : null,
            tags: currentModalTags,
            tags: currentModalTags,
            target_date: editDate.value || null,
            host_name: editHost.value || null,
            user_notes: editNotes.value || null
        };

        const { error } = await supabase
            .from('book_club_list')
            .update(updates)
            .eq('id', id);

        if (error) throw error;

        // Refresh list and close
        await fetchSavedBooks();
        closeModal();

    } catch (error) {
        console.error('Error updating book:', error);
        showError(`Failed to update book. ${error.message || ''}`);
    } finally {
        modalUpdateBtn.textContent = 'Update Details';
        modalUpdateBtn.disabled = false;
    }
}

async function deleteBook(id) {
    // Use a custom non-blocking confirmation or just proceed for now to fix the "wonky" behavior
    // Ideally we'd use a custom modal for confirmation too, but for now let's trust the user clicked delete.
    // if (!confirm('Are you sure you want to delete this book from your list?')) return;

    try {
        modalDeleteBtn.textContent = 'Deleting...';
        modalDeleteBtn.disabled = true;

        const numericId = Number(id);
        if (isNaN(numericId)) {
            throw new Error(`Invalid book ID: ${id}`);
        }
        console.log(`Attempting to delete book with ID: ${numericId}`);

        const { error } = await supabase
            .from('book_club_list')
            .delete()
            .eq('id', numericId);

        if (error) throw error;

        // Refresh list and close
        await fetchSavedBooks();
        closeModal();

    } catch (error) {
        console.error('Error deleting book:', error);
        showError(`Failed to delete book. ${error.message || ''}`);
        modalDeleteBtn.textContent = 'Delete';
        modalDeleteBtn.disabled = false;
    }
}

// --- Tag Management Logic ---

function updateTagSuggestions() {
    const tags = new Set();
    allSavedBooks.forEach(book => {
        if (book.tags) {
            book.tags.forEach(t => tags.add(t));
        }
    });

    tagSuggestions.innerHTML = '';
    Array.from(tags).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        tagSuggestions.appendChild(option);
    });
}

// See More Button
seeMoreBtn.addEventListener('click', () => {
    modalDescriptionContainer.classList.toggle('line-clamp-3');
    seeMoreBtn.textContent = modalDescriptionContainer.classList.contains('line-clamp-3') ? 'See more' : 'See less';
});

function renderModalTags() {
    modalTagsContainer.innerHTML = '';
    currentModalTags.forEach(tag => {
        const chip = document.createElement('span');
        chip.className = `inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getTagColor(tag)}`;
        chip.innerHTML = `
            ${tag}
            <button type="button" class="ml-1.5 inline-flex items-center justify-center w-4 h-4 rounded-full hover:bg-black/10 transition focus:outline-none" onclick="removeTagFromModal('${tag}')">
                <span class="sr-only">Remove ${tag}</span>
                <iconify-icon icon="solar:close-circle-broken" class="text-xs"></iconify-icon>
            </button>
        `;
        modalTagsContainer.appendChild(chip);
    });
}

function addTagToModal() {
    const val = addTagInput.value.trim();
    if (val && !currentModalTags.includes(val)) {
        currentModalTags.push(val);
        renderModalTags();
        addTagInput.value = '';
    }
}

// Expose to window for onclick
window.removeTagFromModal = function (tag) {
    currentModalTags = currentModalTags.filter(t => t !== tag);
    renderModalTags();
};

addTagBtn.addEventListener('click', addTagToModal);
addTagInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        e.preventDefault();
        addTagToModal();
    }
});

async function removeTagFromCard(e, bookId, tag) {
    e.stopPropagation(); // Prevent modal open
    if (!confirm(`Remove tag "${tag}"?`)) return;

    // bookId comes from HTML attribute as string, but data ID is number
    const book = allSavedBooks.find(b => b.id == bookId);
    if (!book) {
        console.error('Book not found for tag removal', bookId);
        return;
    }

    const newTags = (book.tags || []).filter(t => t !== tag);

    const { error } = await supabase
        .from('book_club_list')
        .update({ tags: newTags })
        .eq('id', bookId);

    if (error) {
        console.error('Error removing tag:', error);
        showError('Failed to remove tag.');
    } else {
        fetchSavedBooks();
    }
}
// Expose for inline onclick
window.removeTagFromCard = removeTagFromCard;


// --- Import Logic ---

importBtn.addEventListener('click', () => {
    importModal.classList.remove('hidden');
    importText.value = '';
    importProgress.classList.add('hidden');
    startImportBtn.disabled = false;
    startImportBtn.textContent = 'Start Import';
});

const closeImport = () => {
    importModal.classList.add('hidden');
    // Reset state
    importText.value = '';
    importText.classList.remove('hidden'); // Show input again
    importInstructions.classList.remove('hidden'); // Show instructions again
    importProgress.classList.add('hidden');
    importReviewSection.classList.add('hidden');
    importAutoSummary.classList.add('hidden');
    startImportBtn.classList.remove('hidden');
    saveImportBtn.classList.add('hidden');
    cancelImportBtn.classList.remove('hidden');
    importCandidates = [];
    autoImported = [];
};
closeImportBtn.addEventListener('click', closeImport);
cancelImportBtn.addEventListener('click', closeImport);

startImportBtn.addEventListener('click', async () => {
    const lines = importText.value.split('\n').map(l => l.trim()).filter(l => l);
    if (lines.length === 0) return;

    startImportBtn.classList.add('hidden'); // Hide start button
    importText.classList.add('hidden'); // Hide input to save space
    importInstructions.classList.add('hidden'); // Hide instructions to save space
    importProgress.classList.remove('hidden');

    // Reset if starting fresh text import (Vision might append, but text usually resets)
    importCandidates = [];
    autoImported = [];

    await searchAndQueueBooks(lines);
});

// Reusable Search Function (Text & Vision)
async function searchAndQueueBooks(queries) {
    if (!queries || queries.length === 0) return;

    const importBar = document.getElementById('import-bar');
    const importStatus = document.getElementById('import-status');

    for (let i = 0; i < queries.length; i++) {
        // Strip leading numbers (e.g. "1. Title" -> "Title")
        let query = queries[i].replace(/^\d+\.?\s*/, '').trim();

        // Smart Filter: Ignore empty lines, short lines, or instructional text
        if (!query || query.length < 3 || query.toLowerCase().includes('here they are')) continue;

        const percent = Math.round(((i + 1) / queries.length) * 100);
        importBar.style.width = `${percent}%`;
        importStatus.textContent = `Searching for "${query}"... (${i + 1}/${queries.length})`;

        try {
            // Check for "Title - Author" format
            let searchUrl = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(query)}&maxResults=10&key=${GOOGLE_API_KEY}`;
            let title = query;
            let author = '';

            // Check for "Title - Author" format (handling Hyphen, En Dash, Em Dash)
            const splitRegex = /\s+[–—−-]\s+/;

            if (splitRegex.test(query)) {
                const parts = query.split(splitRegex);
                if (parts.length >= 2) {
                    title = parts[0].trim();
                    author = parts[1].trim();
                    // If author exists, make search more specific
                    searchUrl = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(title + ' inauthor:' + author)}&maxResults=10&key=${GOOGLE_API_KEY}`;
                }
            }

            // Add delay to prevent rate limiting
            await new Promise(r => setTimeout(r, 300));

            // 1. Search Google Books (Max 3 results)
            const res = await fetch(searchUrl);
            const data = await res.json();

            if (data.items && data.items.length > 0) {
                // Filter Duplicates (dedupe by Title + Author)
                const uniqueResults = [];
                const seenKeys = new Set();

                // Prioritize results with images
                const itemsWithImages = data.items.sort((a, b) => {
                    const aImg = a.volumeInfo.imageLinks ? 1 : 0;
                    const bImg = b.volumeInfo.imageLinks ? 1 : 0;
                    return bImg - aImg;
                });

                for (const item of itemsWithImages) {
                    const info = item.volumeInfo;
                    if (!info.title) continue;

                    // distinct key: title(lowercase) + first_author(lowercase)
                    const key = (info.title.toLowerCase().trim()) + '|' + (info.authors ? info.authors[0].toLowerCase().trim() : '');

                    if (!seenKeys.has(key)) {
                        seenKeys.add(key);
                        uniqueResults.push(item);
                    }
                }

                // Use top 3 unique matches
                const finalResults = uniqueResults.slice(0, 3);
                // Replace raw items with filtered list for downstream logic
                data.items = finalResults;

                // Check for TOKEN MATCH (Auto-Import)
                // Check for TOKEN MATCH (Auto-Import)
                const firstBook = data.items[0];
                const info = firstBook.volumeInfo;

                const tokenize = (str) => str ? str.toLowerCase().replace(/[^\w\s]/g, '').split(/\s+/) : [];
                const qTokens = tokenize(title);
                const rTokens = tokenize(info.title);

                // Title Match: Check if ALL significant tokens from query exist in result
                const matchTitle = qTokens.length > 0 && qTokens.every(t => rTokens.includes(t));

                // Author Match: Check if query author (if present) is found in result authors
                const qAuthorTokens = tokenize(author);
                const matchAuthor = author ?
                    (info.authors && info.authors.some(a => {
                        const aTokens = tokenize(a);
                        return qAuthorTokens.every(t => aTokens.includes(t));
                    })) : true;

                // STRICTER AUTO-IMPORT:
                // 1. Must match Title AND Author (if provided).
                // 2. If NO Author provided, Title must be > 1 word to avoid "Exodus" -> Bible issues.
                const safeToAuto = matchTitle && matchAuthor && (author || qTokens.length > 1);

                if (safeToAuto) {
                    // Token match found! Auto-queue it.
                    autoImported.push(firstBook);
                } else {
                    // Ambiguous - add to review list
                    // NO AUTO-SELECT. User must choose.
                    importCandidates.push({
                        query: query,
                        results: data.items,
                        selectedId: null, // Zero Guessing: Force user to pick
                        status: 'ambiguous'
                    });
                }
            } else {
                // No results found
                importCandidates.push({
                    query: query,
                    results: [],
                    selectedId: null,
                    status: 'not_found'
                });
            }
        } catch (err) {
            console.error('Import search error:', err);
            importCandidates.push({
                query: query,
                results: [],
                error: true
            });
        }

        // Small delay
        await new Promise(r => setTimeout(r, 300));
    }

    // Done searching, show review UI
    importProgress.classList.add('hidden');
    renderImportReview();
}

// 2. Fetch More Results (Pagination)
async function fetchMoreResults(queryIndex, currentCount) {
    const candidate = importCandidates[queryIndex];
    if (!candidate) return;

    const btn = document.getElementById(`search-more-${queryIndex}`);
    if (btn) {
        btn.innerHTML = '<iconify-icon icon="line-md:loading-twotone-loop" class="text-lg"></iconify-icon> Searching...';
        btn.disabled = true;
    }

    try {
        // Fetch 5 more results, offset by current count
        const searchUrl = `https://www.googleapis.com/books/v1/volumes?q=${encodeURIComponent(candidate.query)}&startIndex=${currentCount}&maxResults=5&key=${GOOGLE_API_KEY}`;

        const res = await fetch(searchUrl);
        const data = await res.json();

        if (data.items && data.items.length > 0) {
            // Append new results, avoiding duplicates
            const newBooks = data.items.filter(newBook =>
                !candidate.results.some(existing => existing.id === newBook.id)
            );

            candidate.results = [...candidate.results, ...newBooks];
        } else {
            // No more results found, maybe show a toast or disable button permanently?
            // For now, just existing logic will re-render and button will remain but produce no new results if clicked again, 
            // or we could hide it. Let's keep specific feedback simple.
        }
    } catch (err) {
        console.error('Fetch more error:', err);
    }

    renderImportReview();
}

// Helpers for the new UI
function removeAutoImport(index) {
    autoImported.splice(index, 1);
    renderImportReview(); // Re-render to update grid/counts
}

function updateAutoTag(index, value) {
    autoImported[index].tempTags = value;
}

function renderImportReview() {
    importReviewSection.classList.remove('hidden');
    importReviewList.innerHTML = '';
    saveImportBtn.classList.remove('hidden');
    saveImportBtn.disabled = false;
    saveImportBtn.textContent = 'Save Selected';

    // STABLE LAYOUT: Fixed large width, no jumping
    const modalContainer = document.querySelector('#import-modal > div');
    modalContainer.classList.remove('max-w-lg');
    modalContainer.classList.add('w-11/12', 'max-w-6xl', 'h-[90vh]', 'flex', 'flex-col');

    // Make the review list scrollable
    importReviewList.className = 'flex-grow overflow-y-auto px-4 min-h-0 space-y-4 pb-8';
    importReviewSection.classList.remove('hidden');
    importReviewSection.classList.add('flex', 'flex-col', 'h-full', 'min-h-0');

    // 1. Render Candidates (Things needing review)
    // "Library Scale" List Layout
    importCandidates.forEach(item => {
        const wrapper = document.createElement('div');
        wrapper.className = 'bg-white p-4 rounded-xl border border-stone-200 shadow-sm';

        // Header: Query + Skip
        wrapper.innerHTML = `
            <div class="flex justify-between items-center mb-4 border-b border-stone-100 pb-2">
                <div>
                    <p class="text-[10px] font-bold text-stone-400 uppercase tracking-widest">Search Query</p>
                    <p class="font-serif font-bold text-stone-800 text-xl">"${item.query}"</p>
                </div>
                <button onclick="(() => { importCandidates[${importCandidates.indexOf(item)}].selectedId = null; renderImportReview(); })()" 
                    class="text-xs flex items-center gap-1 px-3 py-1.5 rounded-full border border-stone-200 text-stone-500 hover:bg-stone-100 hover:text-stone-700 transition font-medium">
                    <iconify-icon icon="solar:trash-bin-trash-bold"></iconify-icon> Skip Verification
                </button>
            </div>
        `;

        const selectionContainer = document.createElement('div');
        selectionContainer.className = 'space-y-3'; // Spacing between book options

        if (item.results.length === 0) {
            selectionContainer.innerHTML = '<p class="text-sm text-red-500 italic p-4">No matches found.</p>';
        } else {
            item.results.forEach(book => {
                const row = document.createElement('div');
                const isSelected = item.selectedId === book.id;

                // LIBRARY SCALE: Larger padding, clear separation
                row.className = `flex items-center gap-4 p-3 rounded-lg cursor-pointer transition-all duration-200 border-2 ${isSelected ? 'bg-white border-green-500 shadow-md transform scale-[1.01]' : 'bg-white border-transparent hover:border-stone-200 hover:bg-stone-50'}`;

                row.onclick = () => {
                    // Toggle Selection logic (Exclusive selection)
                    item.selectedId = (item.selectedId === book.id) ? null : book.id;
                    renderImportReview();
                };

                const thumb = book.volumeInfo.imageLinks?.thumbnail || 'https://via.placeholder.com/128x192?text=No+Img';
                const authors = book.volumeInfo.authors ? book.volumeInfo.authors.join(', ') : 'Unknown';
                const year = book.volumeInfo.publishedDate ? book.volumeInfo.publishedDate.substring(0, 4) : '';
                const desc = book.volumeInfo.description || 'No description available.';

                // LIBRARY SCALE: Framed Image (w-16 md:w-20), Serif Title
                row.innerHTML = `
                    <div class="flex-shrink-0 w-16 md:w-20 bg-stone-50 border border-stone-200 shadow-sm self-stretch flex items-center justify-center p-1">
                         <img src="${thumb.replace('http:', 'https:')}" class="w-full h-auto object-cover max-h-32 shadow-sm">
                    </div>
                    
                    <div class="flex-grow min-w-0 py-1">
                        <h4 class="font-serif font-bold text-stone-800 text-lg leading-tight mb-1">${book.volumeInfo.title}</h4>
                        <p class="text-sm text-stone-600 mb-1">${authors}</p>
                        ${year ? `<p class="text-xs text-stone-400">${year}</p>` : ''}
                        
                         <div class="mt-2 text-xs text-stone-400 line-clamp-2 leading-relaxed max-w-2xl">
                            ${desc}
                        </div>
                    </div>

                    <div class="flex-shrink-0 px-2">
                         ${isSelected
                        ? '<div class="w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center shadow-sm"><iconify-icon icon="solar:check-circle-bold" class="text-xl"></iconify-icon></div>'
                        : '<div class="w-8 h-8 rounded-full border-2 border-stone-200 hover:border-stone-400 transition-colors"></div>'}
                    </div>
                `;
                selectionContainer.appendChild(row);
            });
        }

        wrapper.appendChild(selectionContainer);
        importReviewList.appendChild(wrapper);
    });

    // 2. Render Auto-Imported Matches (Optional Grid at bottom)
    if (autoImported.length > 0) {
        const gridHeader = document.createElement('div');
        gridHeader.className = 'flex items-center justify-between mb-4 mt-8 px-1 border-t border-stone-200 pt-6';
        gridHeader.innerHTML = `
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center">
                    <iconify-icon icon="solar:magic-stick-3-bold-duotone" class="text-lg"></iconify-icon>
                </div>
                <div>
                     <h4 class="font-bold text-stone-800 text-lg">Auto-Matched Books</h4>
                     <p class="text-xs text-stone-500">High confidence matches (${autoImported.length})</p>
                </div>
            </div>
         `;
        importReviewList.appendChild(gridHeader);

        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-6';

        autoImported.forEach((book, index) => {
            // ... existing grid card logic ...
            // Simplified for this replacement to avoid huge block, but we need it.
            // I'll reuse the existing grid logic structure but keep it clean.
            const info = book.volumeInfo;
            const card = document.createElement('div');
            card.className = "group relative flex flex-col gap-3 rounded-xl p-2 bg-stone-50 border border-stone-100 hover:border-stone-200 transition-colors";

            const thumb = info.imageLinks?.thumbnail || 'https://via.placeholder.com/128x192?text=No+Img';

            card.innerHTML = `
                 <div class="absolute top-2 right-2 z-10">
                     <button onclick="removeAutoImport(${index})" class="bg-white/90 text-stone-400 hover:text-red-500 rounded-full p-1 shadow-sm border border-stone-200 transition-colors">
                        <iconify-icon icon="solar:trash-bin-trash-bold" class="text-base"></iconify-icon>
                     </button>
                 </div>
                 <div class="w-full aspect-[2/3] bg-stone-200 rounded shadow-sm overflow-hidden border border-stone-200">
                     <img src="${thumb.replace('http:', 'https:')}" class="w-full h-full object-cover">
                 </div>
                 <div>
                     <p class="font-bold text-stone-800 text-xs truncate">${info.title}</p>
                     <p class="text-[10px] text-stone-500 truncate">${info.authors ? info.authors[0] : 'Unknown'}</p>
                 </div>
             `;
            grid.appendChild(card);
        });
        importReviewList.appendChild(grid);
    }
}



saveImportBtn.addEventListener('click', async () => {
    // Explicitly check session on click to prevent race conditions
    const { data: sessionData } = await supabase.auth.getSession();
    const currentUser = sessionData?.session?.user;

    console.log('Save clicked. Current User:', currentUser);

    if (!currentUser) {
        alert('You must be logged in to save books. Please reload or log in again.');
        saveImportBtn.textContent = 'Save Selected';
        saveImportBtn.disabled = false;
        return;
    }
    saveImportBtn.textContent = 'Saving...';
    saveImportBtn.disabled = true;

    const booksToSave = [];

    // 1. Auto-imported (Filter by Selected)
    autoImported.forEach(book => {
        // Respect explicit selection (default true)
        if (book.selected === false) return;

        // Use tempTags if available (from edit), else fallback to fresh generate
        const tagsString = book.tempTags !== undefined ? book.tempTags : generateTags(book);
        const tags = tagsString.split(',').map(t => t.trim()).filter(t => t);

        booksToSave.push({
            title: book.volumeInfo.title,
            author: (book.volumeInfo.authors || ['Unknown']).join(', '),
            google_data: book,
            tags: tags
        });
    });

    // 2. Candidates
    importCandidates.forEach(item => {
        // Skip if no selection or explicitly skipped
        if (!item.selectedId || item.status === 'skipped') return;

        const book = item.results.find(b => b.id === item.selectedId);
        if (book) {
            // Use tempTags from the item wrapper (where input bound to)
            // Note: In render, we stored it on item.tempTags
            const tagsString = item.tempTags !== undefined ? item.tempTags : generateTags(book);
            const tags = tagsString.split(',').map(t => t.trim()).filter(t => t);

            booksToSave.push({
                title: book.volumeInfo.title,
                author: (book.volumeInfo.authors || ['Unknown']).join(', '),
                google_data: book,
                tags: tags
            });
        }
    });

    if (booksToSave.length === 0) {
        showError('No books selected to save.');
        saveImportBtn.textContent = 'Save Selected';
        saveImportBtn.disabled = false;
        return;
    }

    const { error } = await supabase
        .from('book_club_list')
        .insert(booksToSave);

    if (error) {
        console.error('Error saving imported books:', error);
        showError('Failed to save books.');
        saveImportBtn.textContent = 'Save Selected';
        saveImportBtn.disabled = false;
    } else {
        showSection('library');
        fetchSavedBooks();
        // Reset and Close
        importText.value = '';
        importReviewSection.classList.add('hidden');
        importModal.classList.add('hidden');
        saveImportBtn.textContent = 'Save Selected';
        saveImportBtn.disabled = false;
        // Clear data
        importCandidates = [];
        autoImported = [];
    }
});

// --- Saved Books Logic ---

let currentView = 'grid'; // 'grid' or 'table'


refreshSavedBtn.addEventListener('click', fetchSavedBooks);

viewGridBtn.addEventListener('click', () => switchView('grid'));
viewTableBtn.addEventListener('click', () => switchView('table'));

// Filter Listeners
// filterStatus listener removed
// filterYear listener removed
filterTag.addEventListener('change', applyFilters);
sortBy.addEventListener('change', applyFilters);

function switchView(view) {
    currentView = view;
    if (view === 'grid') {
        savedGrid.classList.remove('hidden');
        savedTableContainer.classList.add('hidden');
        viewGridBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
        viewGridBtn.classList.remove('text-stone-500');
        viewTableBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
        viewTableBtn.classList.add('text-stone-500');
    } else {
        savedGrid.classList.add('hidden');
        savedTableContainer.classList.remove('hidden');
        viewTableBtn.classList.add('bg-white', 'text-stone-800', 'shadow-sm');
        viewTableBtn.classList.remove('text-stone-500');
        viewGridBtn.classList.remove('bg-white', 'text-stone-800', 'shadow-sm');
        viewGridBtn.classList.add('text-stone-500');
    }
    // Re-render
    applyFilters();
}

async function fetchSavedBooks() {
    if (!user) return;

    refreshSavedBtn.textContent = 'Loading...';
    refreshSavedBtn.disabled = true;

    const { data, error } = await supabase
        .from('book_club_list')
        .select('*')
        .order('created_at', { ascending: false });

    if (error) {
        console.error('Error fetching saved books:', error);
        showError('Could not load your book list.');
    } else {
        allSavedBooks = data || [];

        // Frontend "Migration": Rename long tags for display
        allSavedBooks.forEach(book => {
            if (book.tags && Array.isArray(book.tags)) {
                book.tags = book.tags.map(t => t === 'Business & Economics' ? 'Business/Econ' : t);
            }
        });

        savedBookIds = new Set(allSavedBooks.map(b => b.google_data.id));

        // Sync statuses based on dates
        await syncBookStatuses(allSavedBooks);

        updateYearFilterOptions();
        updateTagFilterOptions();
        applyFilters();
        renderDashboard(); // Also update dashboard when books are fetched
    }

    refreshSavedBtn.textContent = 'Refresh';
    refreshSavedBtn.disabled = false;
}

function updateYearFilterOptions() {
    if (!filterYearMenu) return;

    const years = new Set();
    // Always include current year and next 2 years
    const currentYear = new Date().getFullYear();
    years.add(String(currentYear));
    years.add(String(currentYear + 1));
    years.add(String(currentYear + 2));

    allSavedBooks.forEach(book => {
        if (book.target_date) {
            years.add(book.target_date.substring(0, 4));
        }
    });

    filterYearMenu.innerHTML = '';

    // "All Years" Option
    const allBtn = document.createElement('button');
    allBtn.className = 'w-full text-left px-4 py-2 text-sm text-stone-700 hover:bg-stone-50 hover:text-rose-600 transition font-medium';
    allBtn.textContent = 'All Years';
    allBtn.onclick = () => {
        currentYearFilter = 'all';
        filterYearLabel.textContent = 'All Years';
        applyFilters();
        filterYearMenu.classList.add('hidden');
        updateActiveYearState();
    };
    filterYearMenu.appendChild(allBtn);

    const divider = document.createElement('div');
    divider.className = 'h-px bg-stone-100 my-1';
    filterYearMenu.appendChild(divider);

    Array.from(years).sort().reverse().forEach(year => {
        const btn = document.createElement('button');
        btn.className = 'w-full text-left px-4 py-2 text-sm text-stone-700 hover:bg-stone-50 hover:text-rose-600 transition';
        btn.textContent = year;
        btn.onclick = () => {
            currentYearFilter = year;
            filterYearLabel.textContent = year;
            applyFilters();
            filterYearMenu.classList.add('hidden');
            updateActiveYearState();
        };
        filterYearMenu.appendChild(btn);
    });

    // Reset UI if current filter is no longer valid (optional safety)
    updateActiveYearState();
}

function updateActiveYearState() {
    if (!filterYearMenu) return;
    const buttons = filterYearMenu.querySelectorAll('button');
    buttons.forEach(btn => {
        btn.classList.remove('text-rose-600', 'bg-stone-50');
        // Match label content to filter state
        if ((currentYearFilter === 'all' && btn.textContent === 'All Years') ||
            (btn.textContent === currentYearFilter)) {
            btn.classList.add('text-rose-600', 'bg-stone-50');
        }
    });
}

function updateTagFilterOptions() {
    const tags = new Set();
    allSavedBooks.forEach(book => {
        if (book.tags) {
            book.tags.forEach(t => tags.add(t));
        }
    });

    const currentVal = filterTag.value;
    filterTag.innerHTML = '<option value="all">All Tags</option>';
    Array.from(tags).sort().forEach(tag => {
        const option = document.createElement('option');
        option.value = tag;
        option.textContent = tag;
        filterTag.appendChild(option);
    });
    if (tags.has(currentVal)) filterTag.value = currentVal;
}

function applyFilters() {
    let filtered = [...allSavedBooks];

    // 1. Filter by Status
    const statusVal = currentStatusFilter;
    if (statusVal !== 'all') {
        if (statusVal === 'Saved') {
            // Match null, empty, or explicit 'Saved' (though we use null for default)
            filtered = filtered.filter(b => !b.status || b.status === 'Saved');
        } else {
            filtered = filtered.filter(b => b.status === statusVal);
        }
    }

    // 2. Filter by Year
    const yearVal = currentYearFilter;
    if (yearVal !== 'all') {
        filtered = filtered.filter(b => {
            if (!b.target_date) return false;
            return b.target_date.startsWith(yearVal);
        });
    }

    // 3. Filter by Tag
    const tagVal = filterTag?.value || 'all';
    if (tagVal !== 'all' && tagVal !== '') {
        filtered = filtered.filter(b => b.tags && b.tags.includes(tagVal));
    }

    // 4. Sort
    const sortVal = sortBy?.value || 'date_added_desc';
    filtered.sort((a, b) => {
        switch (sortVal) {
            case 'date_added_desc':
                return new Date(b.created_at) - new Date(a.created_at);
            case 'date_added_asc':
                return new Date(a.created_at) - new Date(b.created_at);
            case 'rating_desc':
                return (b.rating || 0) - (a.rating || 0);
            case 'target_date_asc':
                // Handle nulls last
                if (!a.target_date) return 1;
                if (!b.target_date) return -1;
                return new Date(a.target_date) - new Date(b.target_date);
            case 'title_asc':
                return a.title.localeCompare(b.title);
            default:
                return 0;
        }
    });

    renderSavedBooks(filtered);
}

function showSection(sectionName) {
    // Hide all sections
    document.getElementById('search-section').classList.add('hidden');
    document.getElementById('library-section').classList.add('hidden');
    dashboardSection.classList.add('hidden');

    // Show target
    if (sectionName === 'search') {
        document.getElementById('search-section').classList.remove('hidden');
    } else if (sectionName === 'library') {
        document.getElementById('library-section').classList.remove('hidden');
        applyFilters(); // Call applyFilters to render with current filters
    } else if (sectionName === 'dashboard') {
        dashboardSection.classList.remove('hidden');
        renderDashboard();
    }
}

// Handle Navigation Links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const targetId = this.getAttribute('href').substring(1);

        if (targetId === 'dashboard-section') showSection('dashboard');
        if (targetId === 'search-section') showSection('search');
        if (targetId === 'library-section') showSection('library');
    });
});

function renderDashboard() {
    if (!allSavedBooks || allSavedBooks.length === 0) {
        dashboardHero.classList.add('hidden');
        dashboardUpcomingContainer.classList.add('hidden');
        dashboardEmpty.classList.remove('hidden');
        return;
    }

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    // Filter for future books (target_date >= today)
    const upcomingBooks = allSavedBooks.filter(book => {
        if (!book.target_date) return false;
        // Parse date (YYYY-MM-DD)
        const [year, month, day] = book.target_date.split('-').map(Number);
        const bookDate = new Date(year, month - 1, day);
        return bookDate >= today;
    });

    // Sort by date ascending
    upcomingBooks.sort((a, b) => {
        return new Date(a.target_date) - new Date(b.target_date);
    });

    if (upcomingBooks.length === 0) {
        dashboardHero.classList.add('hidden');
        dashboardUpcomingContainer.classList.add('hidden');
        dashboardEmpty.classList.remove('hidden');
        return;
    }

    // Hide empty state
    dashboardEmpty.classList.add('hidden');

    // 1. Render Hero (First Book)
    const nextBook = upcomingBooks[0];
    const nextInfo = nextBook.google_data.volumeInfo;
    const nextDate = new Date(nextBook.target_date + 'T00:00:00'); // Fix timezone issue
    const daysLeft = Math.ceil((nextDate - today) / (1000 * 60 * 60 * 24));

    // Format date nicely (e.g. "October 15, 2025")
    const dateStr = nextDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });

    dashboardHero.classList.remove('hidden');

    // Apply container classes directly to dashboardHero to avoid "double card"
    dashboardHero.className = 'max-w-3xl mx-auto bg-white rounded-2xl shadow-sm border border-stone-200 overflow-hidden flex flex-row items-center mb-12';

    dashboardHero.innerHTML = `
            <div class="w-1/3 md:w-56 bg-stone-100 flex-shrink-0 border-r border-stone-100 flex items-center justify-center p-4 rounded-l-2xl">
                <img src="${nextInfo.imageLinks?.thumbnail?.replace('http:', 'https:') || 'https://via.placeholder.com/300x450?text=No+Cover'}" 
                    alt="${nextInfo.title}" 
                    class="w-full h-auto shadow-md rounded-sm object-contain max-h-full">
            </div>
            
        <div class="flex-grow p-4 md:p-6 flex flex-col justify-center min-w-0">
            <div class="flex items-center gap-3 mb-2 md:mb-3">
                <span class="bg-rose-50 text-rose-700 border border-rose-100 px-2.5 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider">
                    Next Meeting
                </span>
                <span class="text-xs font-bold text-rose-600 uppercase tracking-wide">
                    ${daysLeft === 0 ? 'Today!' : `In ${daysLeft} days`}
                </span>
            </div>

            <h2 class="font-serif text-xl md:text-3xl font-bold text-stone-900 mb-1 leading-tight line-clamp-2">${nextInfo.title}</h2>
            <p class="text-xs md:text-sm text-stone-500 mb-3 md:mb-5 font-medium truncate">by ${nextInfo.authors ? nextInfo.authors.join(', ') : 'Unknown Author'}</p>

            <div class="flex flex-wrap gap-x-6 gap-y-2 mb-4 md:mb-6 pt-3 md:pt-5 border-t border-stone-100">
                <div>
                    <p class="text-[10px] text-stone-400 uppercase font-bold tracking-wider mb-0.5">Date</p>
                    <p class="text-sm md:text-base font-bold text-stone-800">${dateStr}</p>
                </div>
                ${nextBook.host_name ? `
                    <div>
                        <p class="text-[10px] text-stone-400 uppercase font-bold tracking-wider mb-0.5">Host</p>
                        <p class="text-sm md:text-base font-bold text-stone-800">${nextBook.host_name}</p>
                    </div>` : ''}
            </div>

            <div class="flex flex-wrap gap-2 md:gap-3 mt-auto pt-2 md:pt-4">
                <button onclick="openModal(allSavedBooks.find(b => b.id === ${nextBook.id}).google_data, allSavedBooks.find(b => b.id === ${nextBook.id}))"
                    class="bg-gradient-to-b from-stone-800 to-stone-900 shadow-[inset_0_1px_0_rgba(255,255,255,0.1)] text-white px-5 py-2.5 rounded-lg hover:from-stone-700 hover:to-stone-800 transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-0.5 font-bold text-sm tracking-wide">
                    View Details
                </button>

                <button onclick="openDiscussionModal(allSavedBooks.find(b => b.id === ${nextBook.id}))"
                    class="bg-white text-stone-700 border border-stone-200 px-4 py-2.5 rounded-lg hover:bg-stone-50 hover:border-stone-300 transition-all duration-300 shadow-sm hover:shadow-md font-bold text-sm flex items-center gap-2">
                    <iconify-icon icon="solar:chat-round-dots-broken" class="text-base"></iconify-icon>
                    Guide
                </button>

                <div class="relative">
                    <button onclick="toggleCalendarDropdown(event)" class="bg-white text-stone-700 border border-stone-200 px-4 py-2 rounded-lg hover:bg-stone-50 hover:border-stone-300 transition-all duration-300 shadow-sm hover:shadow-md font-bold text-sm flex items-center gap-2">
                        <iconify-icon icon="solar:calendar-add-broken" class="text-base"></iconify-icon>
                        Add to Calendar
                    </button>
                    <div id="calendar-dropdown" class="absolute bottom-full left-0 mb-2 w-48 bg-white rounded-lg shadow-xl border border-stone-100 hidden z-10 overflow-hidden">
                        <a href="${generateGoogleCalendarLink(nextInfo.title, nextBook.target_date)}" target="_blank" class="block px-4 py-3 text-sm text-stone-700 hover:bg-stone-50 hover:text-rose-600 transition text-left border-b border-stone-50">
                            Google Calendar
                        </a>
                        <button onclick="downloadIcsFile('${nextInfo.title.replace(/'/g, "\\'")}', '${nextBook.target_date}')" class="block w-full text-left px-4 py-3 text-sm text-stone-700 hover:bg-stone-50 hover:text-rose-600 transition">
                        Outlook / Apple
                    </button>
                </div>
            </div>
        </div>
            </div >
        </div >
        `;

    // 2. Render Upcoming List (Rest of books)
    const laterBooks = upcomingBooks.slice(1);

    if (laterBooks.length > 0) {
        dashboardUpcomingContainer.classList.remove('hidden');
        dashboardUpcomingList.innerHTML = laterBooks.map(book => {
            const info = book.google_data.volumeInfo;
            const bDate = new Date(book.target_date + 'T00:00:00');
            const bDateStr = bDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const uniqueId = `cal - upcoming - ${book.id} `;
            const thumbnail = info.imageLinks?.thumbnail?.replace('http:', 'https:') || 'https://via.placeholder.com/128x196?text=No+Cover';

            return `
        <div class="card-modern flex items-center fade-in group relative">
                    <div class="book-frame-modern w-24 border-r border-stone-200 cursor-pointer" onclick="openModal(allSavedBooks.find(b => b.id === ${book.id}).google_data, allSavedBooks.find(b => b.id === ${book.id}))">
                        <img src="${thumbnail}" alt="${info.title}" class="book-cover-shadow h-auto max-h-full object-contain shadow-sm">
                    </div>

        <div class="px-5 py-4 flex flex-col justify-center min-w-0 flex-grow">
            <div onclick="openModal(allSavedBooks.find(b => b.id === ${book.id}).google_data, allSavedBooks.find(b => b.id === ${book.id}))" class="cursor-pointer pt-1">
                <p class="text-[10px] font-bold text-rose-600 mb-1.5 uppercase tracking-wide leading-none">${bDateStr}</p>
                <h3 class="font-bold text-stone-900 text-sm leading-snug mb-1 truncate">${info.title}</h3>
                <p class="text-xs text-stone-500 truncate mb-3">${info.authors ? info.authors[0] : 'Unknown'}</p>
            </div>

            <div class="relative">
                <button onclick="event.stopPropagation(); document.getElementById('${uniqueId}').classList.toggle('hidden')"
                    class="text-[10px] bg-stone-50 text-stone-600 border border-stone-200 px-3 py-1.5 rounded-lg hover:bg-stone-100 transition font-medium flex items-center gap-1 w-fit">
                    <iconify-icon icon="solar:calendar-add-broken" class="text-xs"></iconify-icon>
                    Add to Calendar
                </button>
                <div id="${uniqueId}" class="hidden absolute bottom-full mb-1 left-0 w-40 bg-white rounded-lg shadow-lg border border-stone-100 py-1 z-20">
                    <a href="${generateGoogleCalendarLink(info.title, book.target_date)}" target="_blank"
                        class="block px-3 py-1.5 text-xs text-stone-700 hover:bg-stone-50 font-medium">
                        Google Calendar
                    </a>
                    <a href="#" onclick="downloadICS('${info.title.replace(/'/g, "\\'")}', '${book.target_date}')"
                                    class="block px-3 py-1.5 text-xs text-stone-700 hover:bg-stone-50 font-medium">
                    Outlook / Apple (.ics)
                </a>
            </div>
        </div>
                    </div >
                </div >
        `;
        }).join('');
    } else {
        dashboardUpcomingContainer.classList.add('hidden');
    }
}

function renderSavedBooks(books) {
    savedGrid.innerHTML = '';
    savedTableBody.innerHTML = '';

    if (books.length === 0) {
        savedGrid.innerHTML = '<p class="text-center col-span-full text-stone-500 py-10">No books found matching your filters.</p>';
        savedTableBody.innerHTML = '<tr><td colspan="6" class="px-6 py-4 text-center text-stone-500">No books found.</td></tr>';
        return;
    }

    // Helper for status colors
    const getStatusColor = (status) => {
        switch (status) {
            case 'Priority': return 'bg-rose-100 text-rose-800 border-rose-200';
            case 'Possible': return 'bg-amber-100 text-amber-800 border-amber-200';
            case 'Later': return 'bg-blue-100 text-blue-800 border-blue-200';
            case 'Deprioritize': return 'bg-stone-100 text-stone-600 border-stone-200';
            case 'Read': return 'bg-green-100 text-green-800 border-green-200';
            case 'Proposed': return 'bg-purple-100 text-purple-800 border-purple-200';
            case 'Scheduled': return 'bg-teal-100 text-teal-800 border-teal-200';
            default: return 'bg-stone-50 text-stone-600 border-stone-200'; // Saved/Backlog
        }
    };

    // Helper for tag colors (Notion-like)
    const getTagColor = (tag) => {
        const colors = [
            'bg-red-100 text-red-700', 'bg-orange-100 text-orange-700', 'bg-amber-100 text-amber-700',
            'bg-green-100 text-green-700', 'bg-emerald-100 text-emerald-700', 'bg-teal-100 text-teal-700',
            'bg-cyan-100 text-cyan-700', 'bg-blue-100 text-blue-700', 'bg-indigo-100 text-indigo-700',
            'bg-violet-100 text-violet-700', 'bg-purple-100 text-purple-700', 'bg-fuchsia-100 text-fuchsia-700',
            'bg-pink-100 text-pink-700', 'bg-rose-100 text-rose-700'
        ];
        let hash = 0;
        for (let i = 0; i < tag.length; i++) {
            hash = tag.charCodeAt(i) + ((hash << 5) - hash);
        }
        return colors[Math.abs(hash) % colors.length];
    };
    // Expose for modal
    window.getTagColor = getTagColor;

    books.forEach(row => {
        // Safety Fallback if google_data is missing
        const info = row.google_data?.volumeInfo || {
            title: row.title || 'Unknown Title',
            authors: ['Unknown Author'],
            imageLinks: {}
        };
        const thumbnail = info.imageLinks?.thumbnail?.replace('http:', 'https:') || 'https://via.placeholder.com/128x192?text=No+Cover';
        const authors = info.authors ? info.authors.join(', ') : 'Unknown';
        const status = row.status || 'Saved';
        const statusClass = getStatusColor(status);
        const rating = row.rating ? `★ ${row.rating} ` : '-';
        const date = row.target_date || '-';
        // Derive club year from target_date
        const clubYear = row.target_date ? row.target_date.split('-')[0] : '-';
        const host = row.host_name || '-';

        // --- Grid View Card ---
        const card = document.createElement('div');
        card.className = 'card-modern flex flex-row items-center h-full fade-in group relative';

        // Tags Badge
        const tagsHtml = row.tags && row.tags.length > 0
            ? `<div class="mt-2 flex flex-wrap gap-1"> ${row.tags.map(t => `
                <span class="inline-flex items-center text-[10px] px-1.5 py-0.5 rounded font-medium ${getTagColor(t)} group/tag">
                    ${t}
                    <button onclick="removeTagFromCard(event, '${row.id}', '${t}')" class="ml-1 hidden group-hover/tag:inline-flex hover:text-black/50 items-center justify-center">
                        <iconify-icon icon="solar:close-circle-broken" class="text-[10px]"></iconify-icon>
                    </button>
                </span>`).join('')
            }</div > `
            : '';

        // Status Badge
        const statusHtml = `<span class="text-[10px] px-2 py-0.5 rounded-full border ${statusClass} font-medium"> ${status}</span>`;

        card.innerHTML = `
                <div class="book-frame-modern w-20 md:w-24 border-r border-stone-200 self-stretch">
                    <img src="${thumbnail}" alt="${row.title}" class="book-cover-shadow w-full h-auto max-h-full object-contain shadow-sm">
                </div>

        <div class="p-3 md:p-4 flex flex-col justify-center min-w-0 flex-grow">
            <div class="flex justify-between items-start">
                <h3 class="font-serif font-bold text-base text-stone-800 leading-tight mb-1 truncate" title="${row.title}">${row.title}</h3>
            </div>
            <p class="text-xs text-stone-600 mb-1 truncate">${authors}</p>

            <div class="flex flex-wrap gap-2 mb-2">
                ${statusHtml}
                ${row.rating ? `<span class="text-[10px] px-2 py-0.5 rounded-full bg-yellow-50 text-yellow-700 border border-yellow-200 font-medium">★ ${row.rating}</span>` : ''}
            </div>

            ${clubYear !== '-' ? `<p class="text-[10px] text-stone-500">Club Year: ${clubYear}</p>` : ''}
            ${row.host_name ? `<p class="text-[10px] text-stone-500">Host: ${row.host_name}</p>` : ''}

            ${tagsHtml}
        </div>
    `;
        card.addEventListener('click', () => openModal(row.google_data, row));
        savedGrid.appendChild(card);

        // --- Table View Row ---
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-stone-50 transition cursor-pointer';
        tr.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap">
            <div class="flex items-center">
                <div class="h-10 w-8 flex-shrink-0">
                    <img class="h-10 w-8 rounded object-cover" src="${thumbnail}" alt="">
                </div>
                <div class="ml-4">
                    <div class="text-sm font-medium text-stone-900 truncate max-w-[200px]" title="${row.title}">${row.title}</div>
                    <div class="text-sm text-stone-500 truncate max-w-[150px]">${authors}</div>
                </div>
            </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full border ${statusClass}">
                    ${status}
                </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                ${rating}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                ${host}
            </td>

            <td class="px-6 py-4 text-sm text-stone-500 max-w-xs">
                <div class="flex flex-wrap gap-1">
                    ${row.tags ? row.tags.map(t => `<span class="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${getTagColor(t)}">${t}</span>`).join('') : '-'}
                </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                ${date}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm text-stone-500">
                ${new Date(row.created_at).toLocaleDateString()}
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                <!-- Edit button removed -->
            </td>
    `;
        tr.addEventListener('click', () => openModal(row.google_data, row));
        savedTableBody.appendChild(tr);
    });
}

async function saveBook(button, bookData) {
    const info = bookData.volumeInfo;

    button.textContent = 'Saving...';
    button.disabled = true;

    try {
        // Phase 2: Enrich with Open Library Data immediately
        // We define a timeout to prevent hanging if OL is slow
        const olPromise = getOpenLibraryRating(
            info.industryIdentifiers ? info.industryIdentifiers.find(i => i.type === 'ISBN_13')?.identifier : null,
            info.title,
            info.authors ? info.authors[0] : null
        );

        // Wait max 5 seconds for extra data (OL chain can be slow: ISBN -> Work -> Rating)
        const olData = await Promise.race([
            olPromise,
            new Promise(resolve => setTimeout(() => resolve(null), 5000))
        ]);

        // Logic: Prefer Google Rating if > 100 votes. 
        // Else, check Open Library if > 100 votes.
        // Else, leave null.
        let finalRating = null;

        if (info.averageRating && info.ratingsCount > 100) {
            finalRating = info.averageRating;
        } else if (olData && olData.count > 100) {
            finalRating = olData.average;
        }

        const { error } = await supabase
            .from('book_club_list')
            .insert([
                {
                    title: info.title,
                    author: info.authors ? info.authors.join(', ') : 'Unknown',
                    google_data: bookData,
                    tags: generateTags(bookData).split(', ').filter(t => t),
                    rating: finalRating
                }
            ]);

        if (error) throw error;

        button.textContent = 'Saved!';
        button.classList.remove('bg-white', 'text-rose-600', 'border', 'border-rose-200', 'hover:bg-rose-50');
        button.classList.add('bg-green-100', 'text-green-700', 'border-green-200', 'cursor-default');

        // Refresh the saved list
        fetchSavedBooks();

    } catch (err) {
        console.error('Error saving book:', err);
        button.textContent = 'Error';
        showError('Could not save book. Please try again.');
        button.disabled = false;
    }
}

// Separated for reuse in saveBook
async function getOpenLibraryRating(isbn, title = null, author = null) {
    try {
        let workKey = null;

        // 1. Try ISBN Lookup
        if (isbn) {
            const bookResp = await fetch(`https://openlibrary.org/isbn/${isbn}.json`);
            if (bookResp.ok) {
                const bookData = await bookResp.json();
                workKey = bookData.works?.[0]?.key;
            }
        }

        // 2. Fallback: Search by Title/Author if no work key found
        if (!workKey && title) {
            const query = encodeURIComponent(`${title} ${author || ''}`);
            const searchResp = await fetch(`https://openlibrary.org/search.json?q=${query}&limit=1`);
            if (searchResp.ok) {
                const searchData = await searchResp.json();
                if (searchData.docs && searchData.docs.length > 0) {
                    workKey = searchData.docs[0].key; // e.g., "/works/OL12345W"
                }
            }
        }

        if (!workKey) return null;

        // 3. Get Ratings
        const ratingResp = await fetch(`https://openlibrary.org${workKey}/ratings.json`);
        if (!ratingResp.ok) return null;
        const ratingData = await ratingResp.json();

        if (ratingData.summary?.average) {
            return {
                average: ratingData.summary.average.toFixed(1),
                count: ratingData.summary.count || 0
            };
        }
        return null;

    } catch (err) {
        console.error('Error fetching OL data:', err);
        return null;
    }
}

async function fetchOpenLibraryRating(isbn, title = null, author = null) {
    const avg = await getOpenLibraryRating(isbn, title, author);

    if (avg) {
        modalOlRating.textContent = `OpenLib: ★ ${avg}`;
        modalOlRating.classList.remove('hidden');

        // Auto-fill External Rating if empty
        if (editRating.value === '') {
            editRating.value = avg;
        }
    }
}

async function syncBookStatuses(books) {
    try {
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        const updates = [];

        books.forEach(book => {
            if (!book.target_date) return;

            // Parse date (YYYY-MM-DD)
            const [year, month, day] = book.target_date.split('-').map(Number);
            const bookDate = new Date(year, month - 1, day);

            let newStatus = null;

            // 1. Past Date Logic: Only auto-mark as 'Read' if it was 'Scheduled' or 'Priority'
            // We do NOT want to overwrite 'DNF', 'Skipped', 'Reading', etc.
            if (bookDate < today) {
                if (book.status === 'Scheduled' || book.status === 'Priority') {
                    newStatus = 'Read';
                }
            }
            // 2. Future Date Logic: Only auto-mark as 'Scheduled' if it was 'Read' or 'Finished' (Correction mode)
            // We do NOT want to overwrite 'Voting', 'Proposed', 'Priority' just because it has a date.
            else if (bookDate >= today) {
                if (book.status === 'Read' || book.status === 'Finished') {
                    newStatus = 'Scheduled';
                }
            }

            if (newStatus && newStatus !== book.status) {
                updates.push({
                    id: book.id,
                    status: newStatus
                });
                // Optimistically update local state so UI reflects it immediately
                book.status = newStatus;
            }
        });

        if (updates.length > 0) {
            console.log(`Syncing statuses for ${updates.length} books...`);

            // Batch updates to prevent flooding the server/browser
            // Process in chunks of 5 parallel requests
            const CHUNK_SIZE = 5;
            for (let i = 0; i < updates.length; i += CHUNK_SIZE) {
                const chunk = updates.slice(i, i + CHUNK_SIZE);
                await Promise.all(chunk.map(update =>
                    supabase
                        .from('book_club_list')
                        .update({ status: update.status })
                        .eq('id', update.id)
                ));
            }
            console.log('Status sync complete.');
        }
    } catch (error) {
        console.error('Error syncing book statuses:', error);
        // Don't throw, just log. We don't want to break the app if sync fails.
    }
}

function generateGoogleCalendarLink(title, dateStr) {
    // Default to 7:00 PM - 9:00 PM on the target date
    const startDate = new Date(dateStr + 'T19:00:00');
    const endDate = new Date(dateStr + 'T21:00:00');

    const format = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");

    const params = new URLSearchParams({
        action: 'TEMPLATE',
        text: `Book Club: ${title}`,
        details: `Discussing ${title}. Find discussion questions here: https://www.google.com/search?q=${encodeURIComponent(title + ' book club discussion questions')}`,
        dates: `${format(startDate)}/${format(endDate)}`
    });

    return `https://calendar.google.com/calendar/render?${params.toString()}`;
}

function downloadIcsFile(title, dateStr) {
    const startDate = new Date(dateStr + 'T19:00:00');
    const endDate = new Date(dateStr + 'T21:00:00');
    const now = new Date();

    const format = (date) => date.toISOString().replace(/-|:|\.\d\d\d/g, "");

    const icsContent = [
        'BEGIN:VCALENDAR',
        'VERSION:2.0',
        'PRODID:-//Book Club Companion//EN',
        'BEGIN:VEVENT',
        `UID:${now.getTime()}@bookclubcompanion.com`,
        `DTSTAMP:${format(now)}`,
        `DTSTART:${format(startDate)}`,
        `DTEND:${format(endDate)}`,
        `SUMMARY:Book Club: ${title}`,
        `DESCRIPTION:Discussing ${title}.`,
        'END:VEVENT',
        'END:VCALENDAR'
    ].join('\r\n');

    const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
    const link = document.createElement('a');
    link.href = window.URL.createObjectURL(blob);
    link.download = `book-club-${dateStr}.ics`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
}

function toggleCalendarDropdown(event) {
    event.stopPropagation();
    const dropdown = document.getElementById('calendar-dropdown');
    dropdown.classList.toggle('hidden');
}

// Close dropdown when clicking outside
window.addEventListener('click', () => {
    const dropdown = document.getElementById('calendar-dropdown');
    if (dropdown && !dropdown.classList.contains('hidden')) {
        dropdown.classList.add('hidden');
    }
});

// --- Discussion Guide Logic ---

let currentDiscussionBook = null;

const CURATED_QUESTIONS = {
    'Origins of The Wheel of Time': [
        "Michael Livingston argues that Robert Jordan’s experiences in Vietnam fundamentally shaped the moral landscape of The Wheel of Time. How do you see the \"fog of war\" and the trauma of combat reflected in the journeys of Rand, Mat, and Perrin?",
        "The book highlights the real-world mythology (Arthurian, Norse, Eastern) that Jordan wove into the pattern. Which mythological parallel surprised you the most, and did learning its origin change how you view that part of the story?",
        "Livingston had access to Jordan’s private notes and the \"Bonepile.\" Did this behind-the-scenes look demystify the magic of the series for you, or did it deepen your appreciation for Jordan's architectural genius?",
        "The relationship between Jordan (James Rigney) and his editor/wife Harriet McDougal is central to the book's creation. How does understanding their creative partnership alter your perception of the strong female characters in the series?",
        "Livingston touches on the \"Great Lord of the Dark\" being a force of chaos and selfishness rather than just \"evil.\" How does this nuance in the book's philosophy resonate with the real-world struggles Jordan faced?",
        "The book discusses the iconic (and sometimes controversial) cover art of the series. Did learning about the constraints and choices behind the covers change your opinion of them?",
        "Jordan was a student of history. How do real-world political maneuvers discussed in the book (like the Game of Houses) mirror historical events mentioned by Livingston?",
        "The One Power is often cited as a \"hard\" magic system. Did the book reveal any \"soft\" edges or initial concepts that were later rigidified?",
        "The book touches on the early internet fandom. How does the \"pre-internet\" experience of reading the books compare to the modern, hyper-connected analysis?",
        "Michael Livingston is both a fan and a scholar. Did you find his personal interjections and \"fan moments\" helpful to the narrative, or did they distract from the scholarly analysis?"
    ],
    'Project Hail Mary': [
        "Ryland Grace starts as a coward and ends as a hero. At what point do you think he truly changed? Was it a specific moment, or a gradual shift?",
        "Rocky is an alien, yet he feels incredibly human. How does their friendship compare to human friendships in the book? What does it say about the universal nature of connection?",
        "The book relies heavily on science and problem-solving. Did you find the \"competence porn\" satisfying, or did it ever feel like too much?",
        "Stratt is a polarizing character. Do you think her \"ends justify the means\" approach was necessary to save humanity? Would you have made the same choices?",
        "The ending is bittersweet. Were you satisfied with Grace's choice to stay on Erid? Why or why not?",
        "How does the theme of memory loss impact the narrative? Did uncovering Grace's past change your opinion of him?",
        "If you were in Grace's shoes, waking up alone on a spaceship, what would be your first reaction?",
        "The book explores the idea of \"life\" finding a way (the Astrophage). Did you find yourself sympathizing with the \"villain\" (the algae) at all?",
        "What does the book suggest about the role of teachers and education in society?",
        "Rocky's language is musical. How did you imagine his voice sounding? Did the communication barrier enhance or hinder their bond?",
        "The concept of \"panspermia\" suggests life shares a common origin. How does this theme resonate with the cooperation between species in the book?",
        "Was the sacrifice of the other crew members (Yao and Ilyukhina) given enough weight, or were they just plot devices?"
    ],
    'Lessons in Chemistry': [
        "Elizabeth Zott refuses to accept the limits placed on her by society. In what ways is she a \"modern\" woman, and in what ways is she a product of her time?",
        "The book explores the difference between \"chemistry\" (science) and \"chemistry\" (love/cooking). How does Elizabeth use cooking as a tool for empowerment?",
        "Six-Thirty is a beloved character. What role does he play in the story? Is he just a dog, or something more?",
        "The relationship between Elizabeth and Calvin is tragic but pivotal. How does his memory continue to shape her life and choices?",
        "Harriet Sloane is a crucial support system. What does the book say about female friendship and the \"village\" it takes to raise a family (and a career)?",
        "The book tackles serious issues (sexual assault, sexism) with a sometimes humorous tone. Did this balance work for you?",
        "\"Supper at Six\" becomes a phenomenon. Why do you think her message resonated so strongly with the housewives of America?",
        "Madeline is a precocious child. Do you think her character was realistic? How does she reflect her parents?",
        "What did you make of the ending? Was it too neat, or a well-deserved victory lap?",
        "The book suggests that \"cooking is chemistry.\" Do you agree? How has this book changed the way you view the domestic sphere?",
        "Elizabeth is often described as \"difficult.\" Is she difficult, or just uncompromising? How would a man with her personality be described?",
        "The theme of \"faith\" vs. \"science\" comes up. How does Elizabeth navigate the world of belief without compromising her scientific principles?"
    ],
    'The Seven Husbands of Evelyn Hugo': [
        "Evelyn is unapologetically ambitious. Did you admire her drive, or did you find her ruthless? Can a woman be both?",
        "Which of the seven husbands was your favorite? Which was the worst? Why?",
        "The central love story is not with a husband, but with Celia St. James. Were you surprised by this reveal? How did it reframe the rest of the book for you?",
        "Evelyn hides her true self to protect her career. In the age of social media, do you think celebrities still have to do this, or has the nature of fame changed?",
        "Monique is the vessel for Evelyn's story. Did you care about Monique's personal journey, or were you just waiting to get back to Evelyn?",
        "The \"green dress\" scene is iconic. What does it represent about Evelyn's use of her sexuality as a weapon/tool?",
        "Harry Cameron is Evelyn's platonic soulmate. Is their love any less valid than her romantic love for Celia?",
        "Evelyn makes some morally gray choices (e.g., the car accident). Did you forgive her? Does she deserve forgiveness?",
        "The title suggests the husbands define her, but the book proves otherwise. What actually defines Evelyn Hugo?",
        "\"They are just husbands. I am Evelyn Hugo.\" Discuss this quote. What does it say about identity and ownership of one's life?",
        "How does the book explore the intersection of race and Hollywood? (Evelyn changing her name/hair).",
        "If Evelyn were a real person today, who would she be? (e.g., Marilyn Monroe, Elizabeth Taylor)."
    ]
};

const UNIVERSAL_QUESTIONS = [
    "What was your initial reaction to the book? Did it hook you immediately, or did it take some time to get into?",
    "Which character did you relate to the most, and why?",
    "Was there a specific passage or quote that stood out to you?",
    "How did the setting impact the story? Could this story have taken place anywhere else?",
    "Did the book change your opinion or perspective on any real-world issues?",
    "How did you feel about the pacing? Were there sections that felt too fast or too slow?",
    "Was the ending satisfying? Did it resolve the main conflicts, or leave too much open?",
    "How does the title relate to the story? Is it literal, symbolic, or ironic?",
    "If this book were adapted into a movie or TV show, who would you cast as the main characters?",
    "Who would you recommend this book to? Is there anyone you would specifically tell to avoid it?"
];

function getDiscussionQuestions(book) {
    if (book.discussion_questions) {
        return book.discussion_questions;
    }
    // Check for curated questions (exact title match)
    const title = book.google_data.volumeInfo.title;
    if (CURATED_QUESTIONS[title]) {
        return CURATED_QUESTIONS[title].join('\n\n');
    }
    // Fallback
    return UNIVERSAL_QUESTIONS.join('\n\n');
}

function openDiscussionModal(book) {
    currentDiscussionBook = book;
    const modal = document.getElementById('discussion-modal');
    const titleEl = document.getElementById('discussion-modal-title');
    const viewEl = document.getElementById('discussion-content-view');
    const editEl = document.getElementById('discussion-content-edit');

    titleEl.textContent = book.google_data.volumeInfo.title;

    const questions = getDiscussionQuestions(book);

    // Populate View
    // Populate View with Numbering
    viewEl.innerHTML = questions.split('\n').filter(q => q.trim()).map((q, index) => {
        // Check if it's already numbered (e.g. from user edit)
        const isNumbered = /^\d+\./.test(q);
        const text = isNumbered ? q : `${index + 1}. ${q}`;
        return `<p class="mb-4 font-serif text-lg text-stone-800 leading-relaxed pl-4 -indent-4">${text}</p>`;
    }).join('');

    // Populate Edit
    editEl.value = questions;

    // Reset State
    viewEl.classList.remove('hidden');
    editEl.classList.add('hidden');
    document.getElementById('btn-edit-questions').textContent = 'Edit Questions';
    document.getElementById('btn-save-questions').classList.add('hidden');

    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

function closeDiscussionModal() {
    const modal = document.getElementById('discussion-modal');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    currentDiscussionBook = null;
}

function toggleEditQuestions() {
    const viewEl = document.getElementById('discussion-content-view');
    const editEl = document.getElementById('discussion-content-edit');
    const editBtn = document.getElementById('btn-edit-questions');
    const saveBtn = document.getElementById('btn-save-questions');

    if (editEl.classList.contains('hidden')) {
        // Switch to Edit Mode
        viewEl.classList.add('hidden');
        editEl.classList.remove('hidden');
        editBtn.textContent = 'Cancel';
        saveBtn.classList.remove('hidden');
        editEl.focus();
    } else {
        // Switch to View Mode (Cancel)
        editEl.classList.add('hidden');
        viewEl.classList.remove('hidden');
        editBtn.textContent = 'Edit Questions';
        saveBtn.classList.add('hidden');
        // Reset value
        editEl.value = getDiscussionQuestions(currentDiscussionBook);
    }
}

async function saveDiscussionQuestions() {
    if (!currentDiscussionBook) return;

    const editEl = document.getElementById('discussion-content-edit');
    const saveBtn = document.getElementById('btn-save-questions');
    const newQuestions = editEl.value;

    saveBtn.textContent = 'Saving...';
    saveBtn.disabled = true;

    try {
        const { error } = await supabase
            .from('book_club_list')
            .update({ discussion_questions: newQuestions })
            .eq('id', currentDiscussionBook.id);

        if (error) throw error;

        // Update local state
        currentDiscussionBook.discussion_questions = newQuestions;

        // Refresh View with Numbering
        const viewEl = document.getElementById('discussion-content-view');
        viewEl.innerHTML = newQuestions.split('\n').filter(q => q.trim()).map((q, index) => {
            const isNumbered = /^\d+\./.test(q);
            const text = isNumbered ? q : `${index + 1}. ${q}`;
            return `<p class="mb-4 font-serif text-lg text-stone-800 leading-relaxed pl-4 -indent-4">${text}</p>`;
        }).join('');

        // Switch back to View Mode
        toggleEditQuestions();
        saveBtn.textContent = 'Save Changes';
        saveBtn.disabled = false;

    } catch (err) {
        console.error('Error saving questions:', err);
        saveBtn.textContent = 'Error';
        setTimeout(() => {
            saveBtn.textContent = 'Save Changes';
            saveBtn.disabled = false;
        }, 2000);
    }
}

function printDiscussionGuide() {
    if (!currentDiscussionBook) return;

    const title = currentDiscussionBook.google_data.volumeInfo.title;
    const questions = getDiscussionQuestions(currentDiscussionBook);

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
        <head>
            <title>Discussion Guide: ${title}</title>
            <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
            <style>
                @page { 
                    margin: 0; 
                    size: auto;
                }
                body { 
                    font-family: 'Inter', sans-serif; 
                    color: #1c1917; 
                    background: white;
                    /* Simulate margins here to hide browser headers/footers */
                    padding: 40px 60px; 
                    max-width: 800px; 
                    margin: 0 auto; 
                }
                .header { 
                    border-bottom: 2px solid #f5f5f4; 
                    padding-bottom: 24px; 
                    margin-bottom: 40px; 
                    margin-top: 20px;
                }
                .brand { 
                    font-family: 'Inter', sans-serif; 
                    font-size: 11px; 
                    font-weight: 600; 
                    text-transform: uppercase; 
                    letter-spacing: 2px; 
                    color: #be123c; /* Rose-700 */
                    margin-bottom: 12px; 
                }
                h1 { 
                    font-family: 'Playfair Display', serif; 
                    font-size: 36px; 
                    font-weight: 700; 
                    margin: 0; 
                    color: #1c1917; 
                    line-height: 1.2;
                }
                .question-container { 
                    margin-bottom: 24px; 
                    break-inside: avoid; 
                    display: flex; 
                    gap: 12px;
                }
                .question-num { 
                    font-family: 'Playfair Display', serif; 
                    font-weight: 700; 
                    color: #e11d48; /* Rose-600 */
                    font-size: 18px; 
                    min-width: 24px;
                }
                .question-text { 
                    font-size: 16px; 
                    line-height: 1.6; 
                    color: #44403c; 
                }
                .footer { 
                    position: fixed; 
                    bottom: 20px; 
                    left: 0; 
                    right: 0; 
                    text-align: center; 
                    font-size: 10px; 
                    color: #a8a29e; 
                    background: white;
                }
                @media print {
                    body { -webkit-print-color-adjust: exact; }
                }
            </style>
        </head>
        <body>
            <div class="header">
                <div class="brand">Book Club Companion</div>
                <h1>${title}</h1>
            </div>
            
            <div class="content">
                ${questions.split('\n').filter(q => q.trim()).map((q, index) => {
        // Strip existing numbering if present to use our styled numbering
        const cleanText = q.replace(/^\d+\.\s*/, '');
        return `
                        <div class="question-container">
                            <div class="question-num">${index + 1}.</div>
                            <div class="question-text">${cleanText}</div>
                        </div>
                    `;
    }).join('')}
            </div>

            <div class="footer">
                Generated by Book Club Companion
            </div>

            <script>
                window.onload = function() { window.print(); }
            </script>
        </body>
        </html>
    `);
    printWindow.document.close();
}

// --- Visual Import (Gemini AI) ---

// Init immediately (script is at bottom of body)
(function initVisualImport() {
    const toggleApiKeyBtn = document.getElementById('toggle-api-key');
    const apiKeyContainer = document.getElementById('api-key-container');
    const geminiApiKeyInput = document.getElementById('gemini-api-key');
    const imageUploadInput = document.getElementById('image-upload');
    const imagePreviewContainer = document.getElementById('image-preview-container');

    // Check for Config Key (Environment Variable Simulation)
    let configKey = null;
    if (typeof CONFIG !== 'undefined' && CONFIG.GOOGLE_GEMINI_API_KEY) {
        configKey = CONFIG.GOOGLE_GEMINI_API_KEY;
    }

    // 0. Init State based on Config
    if (configKey) {
        // If key is configured in code, hide the setup UI to keep it clean for the user
        if (toggleApiKeyBtn) toggleApiKeyBtn.classList.add('hidden');
        if (apiKeyContainer) apiKeyContainer.classList.add('hidden');
    } else {
        // 1. Toggle Key Input (Only if manual setup needed)
        if (toggleApiKeyBtn) {
            toggleApiKeyBtn.addEventListener('click', () => {
                apiKeyContainer.classList.toggle('hidden');
                // Load saved key
                const savedKey = localStorage.getItem('gemini_api_key');
                if (savedKey) geminiApiKeyInput.value = savedKey;
            });
        }

        // 2. Save Key on Input
        if (geminiApiKeyInput) {
            geminiApiKeyInput.addEventListener('input', (e) => {
                localStorage.setItem('gemini_api_key', e.target.value.trim());
            });
        }
    }

    // 3. Handle Image Upload
    if (imageUploadInput) {
        const handleFile = async (file) => {
            if (!file) return;

            // Support for simple text file upload (.txt)
            if (file.type === 'text/plain' || file.name.endsWith('.txt')) {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const text = e.target.result;
                    const queries = text.split('\n')
                        .map(l => l.trim())
                        .filter(l => l.length > 0);

                    if (queries.length > 0) {
                        if (imagePreviewContainer) {
                            imagePreviewContainer.innerHTML = `
                                <div class="relative rounded-lg overflow-hidden border border-blue-200 bg-blue-50 p-3 text-center">
                                    <iconify-icon icon="solar:document-text-bold" class="text-blue-600 text-xl mb-1"></iconify-icon>
                                    <p class="text-xs text-blue-800 font-bold">Processing ${queries.length} titles from text file...</p>
                                </div>
                            `;
                            imagePreviewContainer.classList.remove('hidden');
                        }
                        const importProgress = document.getElementById('import-progress');
                        if (importProgress) importProgress.classList.remove('hidden');

                        await searchAndQueueBooks(queries);
                    } else {
                        alert('File seems empty.');
                    }
                };
                reader.readAsText(file);
                return;
            }

            // Validation: Use Config Key OR Local Storage
            const apiKey = configKey || localStorage.getItem('gemini_api_key');

            if (!apiKey) {
                alert('Please setup your Google Gemini API Key first.');
                if (apiKeyContainer) {
                    apiKeyContainer.classList.remove('hidden');
                    if (geminiApiKeyInput) geminiApiKeyInput.focus();
                }
                return;
            }

            // Show Preview & Loop Logic
            const reader = new FileReader();
            reader.onload = async (e) => {
                const base64Data = e.target.result;
                if (imagePreviewContainer) {
                    imagePreviewContainer.innerHTML = `
                        <div class="relative rounded-lg overflow-hidden border border-stone-200">
                            <img src="${base64Data}" class="w-full h-48 object-cover opacity-50">
                            <div class="absolute inset-0 flex items-center justify-center">
                                <div class="bg-white/90 px-4 py-2 rounded-full shadow-sm flex items-center gap-2">
                                    <iconify-icon icon="svg-spinners:ring-resize" class="text-amber-600 text-xl"></iconify-icon>
                                    <span class="text-xs font-bold text-amber-800">Analyzing Books...</span>
                                </div>
                            </div>
                        </div>
                    `;
                    imagePreviewContainer.classList.remove('hidden');
                }

                try {
                    const results = await callGeminiVision(base64Data, apiKey);

                    if (results && results.length > 0) {
                        const queries = results.map(b => `${b.title} - ${b.author}`);
                        const importProgress = document.getElementById('import-progress');
                        if (importProgress) importProgress.classList.remove('hidden');
                        await searchAndQueueBooks(queries);
                        if (imagePreviewContainer) {
                            imagePreviewContainer.innerHTML = `
                                <div class="relative rounded-lg overflow-hidden border border-green-200 bg-green-50 p-3 text-center">
                                    <iconify-icon icon="solar:check-circle-bold" class="text-green-600 text-xl mb-1"></iconify-icon>
                                    <p class="text-xs text-green-800 font-bold">Found ${results.length} books!</p>
                                </div>
                            `;
                        }
                    } else {
                        alert('No books detected. Try a clearer photo.');
                        if (imagePreviewContainer) imagePreviewContainer.innerHTML = '';
                    }
                } catch (err) {
                    console.error(err);
                    if (imagePreviewContainer) {
                        imagePreviewContainer.innerHTML = `
                            <div class="bg-red-50 text-red-600 text-xs p-3 rounded">
                                Error: ${err.message}. Check your API Key.
                            </div>
                        `;
                    }
                }
            };
            reader.readAsDataURL(file);
        };

        // Standard Input Change
        imageUploadInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        // Robust Drag & Drop on Container
        const dropZone = document.getElementById('drop-zone');

        if (dropZone) {
            // Drag Events
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                dropZone.addEventListener(eventName, preventDefaults, false);
            });

            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }

            dropZone.addEventListener('dragover', () => {
                dropZone.classList.add('bg-rose-50', 'border-rose-300');
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.classList.remove('bg-rose-50', 'border-rose-300');
            });

            dropZone.addEventListener('drop', (e) => {
                dropZone.classList.remove('bg-rose-50', 'border-rose-300');
                const dt = e.dataTransfer;
                const file = dt.files[0];
                handleFile(file);
            });
        }
    }

    async function callGeminiVision(base64Data, apiKey) {
        const base64Image = base64Data.split(',')[1]; // Remove header

        const prompt = `
            Analyze this image. Identify all books visible (covers or spines) or read the text if it's a list.
            Return strictly a JSON array of objects with "title" and "author" keys.
            Example: [{"title": "The Great Gatsby", "author": "F. Scott Fitzgerald"}]
            If no books found, return [].
        `;

        const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-flash-latest:generateContent?key=${apiKey}`;

        const payload = {
            contents: [{
                parts: [
                    { text: prompt },
                    { inline_data: { mime_type: "image/jpeg", data: base64Image } }
                ]
            }]
        };

        const response = await fetch(url, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!response.ok) {
            const errorBody = await response.text();
            console.error('Gemini API Error details:', errorBody);
            throw new Error(`API Error (${response.status}): ${response.statusText}`);
        }

        const data = await response.json();
        const text = data.candidates?.[0]?.content?.parts?.[0]?.text;

        if (!text) return [];

        // Clean Markdown code blocks if present
        const jsonStr = text.replace(/```json/g, '').replace(/```/g, '').trim();
        return JSON.parse(jsonStr);
    }
})();
